<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Bussigt! ‚Äî Se dina bussar live</title>
  <meta name="description" content="Se var dina bussar √§r just nu. V√§lj h√•llplats och linjer ‚Äî f√• realtidspositioner och ETA direkt i mobilen.">
  <meta property="og:title" content="Bussigt! ‚Äî Se dina bussar live">
  <meta property="og:description" content="Realtidskarta f√∂r bussar i Nacka, Saltsj√∂baden och V√§rmd√∂. V√§lj din h√•llplats och se bussarna p√• kartan.">
  <meta property="og:url" content="https://lookma.se/bussigt/">
  <meta property="og:type" content="website">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Bussigt!">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="stylesheet" href="leaflet.css" />
  <script src="leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }
    #map { width: 100vw; height: 100vh; height: 100dvh; }
    /* Fix Leaflet tile grid lines on Retina/mobile */
    .leaflet-tile { outline: none !important; border: none !important; image-rendering: auto; }
    .leaflet-tile-container { will-change: transform; }
    .leaflet-fade-anim .leaflet-tile { will-change: opacity, transform; }

    .info-panel {
      position: absolute; top: calc(12px + env(safe-area-inset-top, 0px)); left: 12px; z-index: 1000;
      background: rgba(20, 20, 40, 0.88); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 12px;
      padding: 14px 18px; box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      color: #ccc; max-width: 260px;
    }
    .info-panel h1 { font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 2px; }
    .info-panel .sub { font-size: 0.72rem; color: #888; margin-bottom: 10px; }
    .line-status { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 0.82rem; transition: none; }
    .line-statuses-list.collapsed .line-status:nth-child(n+4) { display: none; }
    .line-toggle { background: none; border: none; color: #60a5fa; font-size: 0.75rem; cursor: pointer; padding: 4px 0; font-weight: 600; }
    .line-toggle:hover { color: #93bbfd; }
    body.light .line-toggle { color: #3b82f6; }
    body.light .line-toggle:hover { color: #2563eb; }
    .line-badge {
      display: inline-flex; align-items: center; justify-content: center;
      min-width: 38px; height: 22px; border-radius: 4px;
      font-weight: 700; font-size: 0.78rem; color: #fff; padding: 0 6px;
    }
    .line-count { color: #e0e0e0; font-weight: 600; }
    .update-time { font-size: 0.7rem; color: #666; margin-top: 8px; }
    .no-buses { font-size: 0.75rem; color: #999; font-style: italic; }
    .source-info {
      font-size: 0.62rem; color: #555; margin-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.05); padding-top: 6px;
    }
    .source-info a { color: #666; text-decoration: none; }
    .source-info a:hover { color: #999; }

    .action-btn {
      position: absolute; z-index: 1000;
      width: 44px; height: 44px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(20, 20, 40, 0.85); backdrop-filter: blur(12px);
      color: #ccc; font-size: 1.3rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      transition: background 0.2s, color 0.2s;
    }
    .action-btn:hover { background: rgba(40,40,70,0.95); color: #fff; }
    .action-btn.active { color: #60a5fa; }
    #locate-btn { bottom: calc(16px + env(safe-area-inset-bottom, 0px)); right: 16px; }
    #settings-btn { bottom: calc(16px + env(safe-area-inset-bottom, 0px)); left: 16px; }

    /* Google-style zoom buttons */
    .zoom-btns {
      position: absolute; z-index: 1000;
      bottom: calc(70px + env(safe-area-inset-bottom, 0px)); right: 16px;
      display: flex; flex-direction: column; gap: 1px;
      border-radius: 10px; overflow: hidden;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
    }
    .zoom-btn {
      width: 44px; height: 44px; border: none;
      background: rgba(20, 20, 40, 0.85); backdrop-filter: blur(12px);
      color: #ccc; font-size: 1.4rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s, color 0.2s;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .zoom-btn:last-child { border-bottom: none; }
    .zoom-btn:hover { background: rgba(40,40,70,0.95); color: #fff; }
    .zoom-btn:active { background: rgba(60,60,100,0.95); }

    /* Light mode */
    body.light { background: #f5f5f5; }
    body.light .info-panel { background: rgba(255,255,255,0.92); border-color: rgba(0,0,0,0.08); color: #333; }
    body.light .info-panel h1 { color: #111; }
    body.light .info-panel .sub { color: #666; }
    body.light .line-count { color: #333; }
    body.light .update-time { color: #999; }
    body.light .source-info { color: #999; border-color: rgba(0,0,0,0.06); }
    body.light .source-info a { color: #888; }
    body.light .action-btn, body.light .zoom-btn { background: rgba(255,255,255,0.9); color: #333; border-color: rgba(0,0,0,0.1); box-shadow: 0 2px 12px rgba(0,0,0,0.15); }
    body.light .action-btn:hover, body.light .zoom-btn:hover { background: #fff; color: #111; }
    body.light .action-btn.active { color: #3b82f6; }
    body.light .leaflet-control-attribution { background: rgba(255,255,255,0.8) !important; color: #999 !important; }
    body.light .leaflet-popup-content-wrapper { background: rgba(255,255,255,0.95) !important; color: #333 !important; border-color: rgba(0,0,0,0.1) !important; box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important; }
    body.light .leaflet-popup-tip { background: rgba(255,255,255,0.95) !important; }

    /* Onboarding overlay */
    .overlay {
      position: fixed; inset: 0; z-index: 2000;
      background: rgba(10, 10, 25, 0.92); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    }
    .overlay.visible { opacity: 1; pointer-events: auto; }
    .overlay.initial { opacity: 1; pointer-events: auto; }
    .overlay-card {
      background: rgba(25, 25, 50, 0.95); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px; padding: 28px 24px; max-width: 380px; width: 90%;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5); color: #e0e0e0;
      max-height: 90vh; overflow-y: auto;
    }
    .overlay-card h2 { font-size: 1.3rem; color: #fff; margin-bottom: 4px; text-align: center; }
    .overlay-card .tagline { font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 20px; }
    .overlay-card label { display: block; font-size: 0.82rem; color: #aaa; margin-bottom: 6px; font-weight: 600; }
    .overlay-card .section { margin-bottom: 18px; }

    .stop-search {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
      background: rgba(15,15,35,0.8); color: #e0e0e0; font-size: 0.9rem;
      outline: none; transition: border-color 0.2s;
    }
    .stop-search:focus { border-color: rgba(96,165,250,0.5); }
    .stop-list {
      max-height: 180px; overflow-y: auto; margin-top: 6px;
      border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);
    }
    .stop-item {
      padding: 10px 12px; cursor: pointer; font-size: 0.82rem; color: #ccc;
      border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.15s;
    }
    .stop-item:last-child { border-bottom: none; }
    .stop-item:hover { background: rgba(96,165,250,0.1); }
    .stop-item.selected { background: rgba(96,165,250,0.2); color: #60a5fa; font-weight: 600; }

    .lines-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 6px;
    }
    .line-check {
      display: flex; align-items: center; gap: 6px; padding: 8px 10px;
      border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);
      background: rgba(15,15,35,0.6); cursor: pointer; transition: all 0.15s;
      font-size: 0.82rem; color: #aaa;
    }
    .line-check:hover { border-color: rgba(255,255,255,0.15); }
    .line-check.checked { border-color: rgba(96,165,250,0.4); background: rgba(96,165,250,0.12); color: #60a5fa; }
    .line-check input { display: none; }

    .save-btn {
      width: 100%; padding: 12px; border: none; border-radius: 10px;
      background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff;
      font-size: 0.95rem; font-weight: 700; cursor: pointer;
      transition: transform 0.1s, box-shadow 0.2s; margin-top: 8px;
    }
    .save-btn:hover { box-shadow: 0 4px 16px rgba(59,130,246,0.3); }
    .save-btn:active { transform: scale(0.98); }
    .save-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .lines-loading { color: #666; font-size: 0.8rem; grid-column: 1/-1; text-align: center; padding: 8px; }

    .leaflet-popup-content-wrapper {
      background: rgba(20, 20, 40, 0.95) !important; color: #e0e0e0 !important;
      border-radius: 10px !important; border: 1px solid rgba(255,255,255,0.1) !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
    }
    .leaflet-popup-tip { background: rgba(20, 20, 40, 0.95) !important; }
    .leaflet-popup-content { margin: 10px 12px !important; font-size: 0.82rem !important; line-height: 1.5 !important; }
    .leaflet-popup-close-button { color: #888 !important; }
    .leaflet-control-attribution { background: rgba(20, 20, 40, 0.7) !important; color: #666 !important; font-size: 0.6rem !important; padding-right: env(safe-area-inset-right, 4px) !important; padding-bottom: env(safe-area-inset-bottom, 0px) !important; }
    .leaflet-control-attribution a { color: #888 !important; }
    .leaflet-control-zoom { display: none !important; }

    /* Light mode: overlay + onboarding */
    body.light .overlay { background: rgba(240, 240, 245, 0.92); }
    body.light .overlay-card { background: rgba(255,255,255,0.97); border-color: rgba(0,0,0,0.08); color: #333; box-shadow: 0 8px 40px rgba(0,0,0,0.15); }
    body.light .overlay-card h2 { color: #111; }
    body.light .overlay-card .tagline { color: #888; }
    body.light .overlay-card label { color: #555; }
    body.light .stop-search { background: rgba(245,245,250,0.9); border-color: rgba(0,0,0,0.1); color: #333; }
    body.light .stop-search:focus { border-color: rgba(59,130,246,0.5); }
    body.light .stop-search::placeholder { color: #999; }
    body.light .stop-list { border-color: rgba(0,0,0,0.06); }
    body.light .stop-item { color: #444; border-color: rgba(0,0,0,0.04); }
    body.light .stop-item:hover { background: rgba(59,130,246,0.08); }
    body.light .stop-item.selected { background: rgba(59,130,246,0.12); color: #3b82f6; }
    body.light .line-check { background: rgba(245,245,250,0.8); border-color: rgba(0,0,0,0.08); color: #555; }
    body.light .line-check:hover { border-color: rgba(0,0,0,0.15); }
    body.light .line-check.checked { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.08); color: #3b82f6; }
    body.light .lines-loading { color: #999; }
    body.light .save-btn { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    body.light #add-line-input { background: rgba(245,245,250,0.9); border-color: rgba(0,0,0,0.1); color: #333; }
    body.light #add-line-btn { background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.3); color: #3b82f6; }

    /* A2HS prompt */
    .a2hs-card { text-align: center; }
    .a2hs-card h2 { margin-bottom: 8px; }
    .a2hs-card .a2hs-desc { font-size: 0.85rem; color: #aaa; margin-bottom: 20px; line-height: 1.5; }
    body.light .a2hs-card .a2hs-desc { color: #666; }
    .a2hs-steps { text-align: left; margin-bottom: 20px; }
    .a2hs-step { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 14px; font-size: 0.85rem; color: #ccc; line-height: 1.5; }
    body.light .a2hs-step { color: #444; }
    .a2hs-step .step-num { flex-shrink: 0; width: 26px; height: 26px; border-radius: 50%; background: rgba(59,130,246,0.2); color: #60a5fa; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
    body.light .a2hs-step .step-num { background: rgba(59,130,246,0.1); color: #3b82f6; }
    .a2hs-icon { font-size: 1.1rem; vertical-align: middle; }
    .a2hs-dismiss { width: 100%; padding: 12px; border: none; border-radius: 10px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: #fff; font-size: 0.95rem; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
    .a2hs-dismiss:active { transform: scale(0.98); }
    .a2hs-skip { display: block; margin-top: 10px; background: none; border: none; color: #888; font-size: 0.8rem; cursor: pointer; width: 100%; text-align: center; }
    .a2hs-skip:hover { color: #aaa; }
    body.light .a2hs-skip { color: #999; }

    .stop-list::-webkit-scrollbar, .overlay-card::-webkit-scrollbar { width: 4px; }
    .stop-list::-webkit-scrollbar-track, .overlay-card::-webkit-scrollbar-track { background: transparent; }
    .stop-list::-webkit-scrollbar-thumb, .overlay-card::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
    body.light .stop-list::-webkit-scrollbar-thumb, body.light .overlay-card::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<!-- Loading handled by onboarding overlay -->
<div id="map"></div>

<div class="info-panel">
  <h1 id="app-title">üöå Bussigt!</h1>
  <div class="sub" id="app-sub">Realtidsbussar</div>
  <div id="line-statuses-wrap">
    <div class="line-statuses-list collapsed" id="line-statuses"><div class="no-buses">V√§lj h√•llplats via ‚öôÔ∏è</div></div>
    <button class="line-toggle" id="line-toggle" style="display:none"></button>
  </div>
  <div class="update-time" id="update-time"></div>
  <div class="source-info">Data: <a href="https://www.trafiklab.se" target="_blank">Trafiklab</a> GTFS Regional ¬∑ <a href="https://lookma.se">Lookma</a></div>
</div>

<button class="action-btn" id="settings-btn" title="Inst√§llningar">‚öôÔ∏è</button>
<button class="action-btn" id="locate-btn" title="Visa min position">‚óâ</button>
<div class="zoom-btns">
  <button class="zoom-btn" id="zoom-in" title="Zooma in">+</button>
  <button class="zoom-btn" id="zoom-out" title="Zooma ut">‚àí</button>
</div>

<!-- Onboarding overlay ‚Äî starts visible, JS hides it if config exists -->
<div class="overlay visible" id="onboarding">
  <div class="overlay-card">
    <h2>üöå Bussigt!</h2>
    <p class="tagline">V√§lj din h√•llplats och dina linjer</p>

    <div class="section">
      <label>üìç Hemmah√•llplats</label>
      <input type="text" class="stop-search" id="stop-search" placeholder="S√∂k h√•llplats..." autocomplete="off">
      <div class="stop-list" id="stop-list"></div>
    </div>

    <div class="section">
      <label id="lines-label">üöç Busslinjer att bevaka</label>
      <div class="lines-grid" id="lines-grid"></div>
      <div style="display:flex;gap:6px;margin-top:10px">
        <input type="text" id="add-line-input" class="stop-search" placeholder="L√§gg till linje (t.ex. 449)" style="flex:1;padding:8px 10px;font-size:0.82rem" inputmode="numeric">
        <button id="add-line-btn" style="padding:8px 14px;border-radius:8px;border:1px solid rgba(96,165,250,0.4);background:rgba(96,165,250,0.15);color:#60a5fa;font-weight:700;font-size:0.82rem;cursor:pointer">+ L√§gg till</button>
      </div>
      <div style="font-size:0.68rem;color:#666;margin-top:4px">Linjer som inte trafikerar just nu kan l√§ggas till manuellt</div>
    </div>

    <div class="section">
      <label>üé® Utseende</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="theme-btn" id="theme-dark" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:#1a1a2e;color:#ccc;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.2s">üåô M√∂rkt</button>
        <button class="theme-btn" id="theme-light" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);background:#f0f0f0;color:#333;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.2s">‚òÄÔ∏è Ljust</button>
      </div>
    </div>

    <button class="save-btn" id="save-btn" disabled>Spara & starta</button>
  </div>
</div>

<!-- Add to Home Screen prompt -->
<div class="overlay" id="a2hs-overlay">
  <div class="overlay-card a2hs-card">
    <h2>üì± L√§gg till p√• hemsk√§rmen</h2>
    <p class="a2hs-desc">Bussigt! fungerar b√§st som app ‚Äî fullsk√§rm, snabbstart och inga adressf√§lt i v√§gen.</p>
    <div class="a2hs-steps" id="a2hs-steps"></div>
    <button class="a2hs-dismiss" id="a2hs-done">Okej, tack!</button>
    <button class="a2hs-skip" id="a2hs-skip">Hoppa √∂ver</button>
  </div>
</div>

<script>
(function() {
  'use strict';

  var _initTimeout = 0; // kept for clearTimeout compatibility

  // ---- Line colors (known + generated palette for unknowns) ----
  const LINE_COLORS = {
    '401':'#6366f1','402':'#8b5cf6','409':'#3182ce','414':'#0891b2',
    '420':'#059669','422':'#65a30d','443':'#d97706','449':'#e53e3e',
    '469':'#0d9488','471':'#db2777','474':'#9333ea',
  };
  const PALETTE = ['#6366f1','#3182ce','#059669','#d97706','#e53e3e','#db2777','#9333ea','#0891b2','#65a30d','#0d9488','#8b5cf6'];
  let paletteIdx = 0;

  function lineColor(num) {
    if (!LINE_COLORS[num]) {
      LINE_COLORS[num] = PALETTE[paletteIdx % PALETTE.length];
      paletteIdx++;
    }
    return LINE_COLORS[num];
  }

  const DEFAULT_CENTER = [59.31, 18.17];
  const DEFAULT_ZOOM = 13;
  const POLL_MS = 5000;
  const LS_KEY = 'bussigt_config';

  // ---- State ----
  let config = null; // { homeStop: {id, siteId, name, lat, lon}, lines: ['449','409',...] }
  let selectedStop = null;
  let selectedLines = new Set();
  let stopSearchResults = []; // from API
  let searchTimer = null;

  // ---- localStorage ----
  function loadConfig() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) { config = JSON.parse(raw); return true; }
    } catch(e) {}
    return false;
  }

  function saveConfig() {
    config = {
      homeStop: selectedStop,
      lines: Array.from(selectedLines)
    };
    localStorage.setItem(LS_KEY, JSON.stringify(config));
  }

  // ---- Map setup ----
  const map = L.map('map', { center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM, zoomControl: false });

  // ---- Persist map view (zoom + center) ----
  function saveMapView() {
    const c = map.getCenter();
    localStorage.setItem('bussigt_view', JSON.stringify({ lat: c.lat, lng: c.lng, zoom: map.getZoom() }));
  }
  function loadMapView() {
    try {
      const raw = localStorage.getItem('bussigt_view');
      if (raw) return JSON.parse(raw);
    } catch(e) {}
    return null;
  }
  map.on('moveend', saveMapView);
  map.on('zoomend', saveMapView);
  // Tile layer set by applyTheme() below

  let homeMarker = null;
  let markers = {};
  let pollTimer = null;

  function setHomeMarker(lat, lon, name) {
    if (homeMarker) map.removeLayer(homeMarker);
    homeMarker = L.marker([lat, lon], {
      icon: L.divIcon({
        html: '<div style="font-size:24px;text-shadow:0 2px 6px rgba(0,0,0,0.5)">üöè</div>',
        className: '', iconSize: [28, 28], iconAnchor: [14, 14],
      })
    }).addTo(map).bindPopup('<strong>üöè ' + name + '</strong>');
  }

  // ---- Bus rendering ----
  function statusText(s) {
    return s === 'STOPPED_AT' ? 'Vid h√•llplats' : s === 'INCOMING_AT' ? 'Anl√§nder' : 'P√• v√§g';
  }

  function bearingArrow(b) {
    if (b == null) return '‚óè';
    return ['‚Üë','‚Üó','‚Üí','‚Üò','‚Üì','‚Üô','‚Üê','‚Üñ'][Math.round(b / 45) % 8];
  }

  function popup(v) {
    const speed = v.speed ? (v.speed * 3.6).toFixed(0) : '0';
    const time = v.timestamp ? new Date(v.timestamp * 1000).toLocaleTimeString('sv-SE', {hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '‚Äî';
    const stopName = config && config.homeStop ? config.homeStop.name : 'hemma';
    const destHtml = v.destination
      ? '<div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.08)">üèÅ <strong>' + v.destination + '</strong>' +
        (v.dest_time ? ' <span style="color:#aaa">kl ' + v.dest_time + '</span>' : '') + '</div>'
      : '';
    const etaHtml = v.eta_minutes != null
      ? '<br>üöè <strong style="color:#fbbf24">' + v.eta_minutes + ' min</strong> till ' + stopName + ' (' + v.eta_time + ')'
      : '';
    return '<div style="font-size:1.1rem;font-weight:700;margin-bottom:4px">' +
      '<span style="color:' + lineColor(v.line) + '">Linje ' + v.line + '</span></div>' +
      '<div style="color:#aaa">' + bearingArrow(v.bearing) + ' ' + statusText(v.status) +
      '<br>üèé ' + speed + ' km/h<br>üïê ' + time + etaHtml + '</div>' + destHtml;
  }

  function busIcon(line, eta) {
    const c = lineColor(line);
    const etaLabel = eta != null ? '<div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);' +
      'background:rgba(20,20,40,0.9);color:#fbbf24;font-size:10px;font-weight:700;font-family:system-ui;' +
      'padding:1px 5px;border-radius:3px;white-space:nowrap;border:1px solid rgba(251,191,36,0.3);' +
      'text-shadow:0 1px 2px rgba(0,0,0,0.5)">' + eta + ' min</div>' : '';
    return L.divIcon({
      html: '<div style="position:relative">' + etaLabel + '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">' +
        '<circle cx="16" cy="16" r="14" fill="' + c + '" stroke="#fff" stroke-width="2" opacity="0.95"/>' +
        '<text x="16" y="20.5" text-anchor="middle" fill="#fff" font-size="' + (line.length > 3 ? '9' : '12') + '" font-weight="700" font-family="system-ui">' + line + '</text></svg></div>',
      className: '', iconSize: [32,32], iconAnchor: [16,16], popupAnchor: [0,-18],
    });
  }

  function updateBuses(vehicles) {
    const active = new Set();
    for (const v of vehicles) {
      active.add(v.id);
      const pos = [v.lat, v.lon];
      const eta = v.eta_minutes != null ? v.eta_minutes : null;
      if (markers[v.id]) {
        markers[v.id].setLatLng(pos).setIcon(busIcon(v.line, eta)).setPopupContent(popup(v));
      } else {
        markers[v.id] = L.marker(pos, {icon: busIcon(v.line, eta)}).bindPopup(popup(v)).addTo(map);
      }
    }
    for (const id of Object.keys(markers)) {
      if (!active.has(id)) { map.removeLayer(markers[id]); delete markers[id]; }
    }

    // Update info panel
    const el = document.getElementById('line-statuses');
    const toggleBtn = document.getElementById('line-toggle');
    const activeLines = config && config.lines ? config.lines : [];
    if (!vehicles.length) {
      el.innerHTML = '<div class="no-buses">Inga bussar ute just nu üò¥</div>';
      toggleBtn.style.display = 'none';
    } else {
      const lineCounts = {};
      for (const v of vehicles) {
        lineCounts[v.line] = (lineCounts[v.line] || 0) + 1;
      }
      const sortedLines = Object.keys(lineCounts).sort((a,b) => a.localeCompare(b, undefined, {numeric:true}));
      const html = sortedLines.map(l => {
        const n = lineCounts[l];
        return '<div class="line-status"><span class="line-badge" style="background:' + lineColor(l) + '">' + l + '</span><span class="line-count">' + n + ' buss' + (n > 1 ? 'ar' : '') + '</span></div>';
      }).join('');
      el.innerHTML = html || '<div class="no-buses">Inga bussar ute just nu üò¥</div>';

      // Collapse toggle
      const MAX_VISIBLE = 3;
      if (sortedLines.length > MAX_VISIBLE) {
        const isCollapsed = el.classList.contains('collapsed');
        toggleBtn.style.display = 'block';
        toggleBtn.textContent = isCollapsed
          ? '‚ñº Visa alla (' + sortedLines.length + ' linjer, ' + vehicles.length + ' bussar)'
          : '‚ñ≤ Minimera';
      } else {
        toggleBtn.style.display = 'none';
        el.classList.remove('collapsed');
      }
    }
    document.getElementById('update-time').textContent =
      'Uppdaterad ' + new Date().toLocaleTimeString('sv-SE', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  }

  async function fetchData() {
    try {
      const lines = config && config.lines.length ? config.lines.join(',') : '';
      if (!lines) return;
      const stop = config && config.homeStop ? config.homeStop.id : '';
      let url = 'api.php?lines=' + encodeURIComponent(lines);
      if (stop) url += '&stop=' + encodeURIComponent(stop);
      const r = await fetch(url);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const d = await r.json();
      if (d.error) throw new Error(d.error);
      updateBuses(d.vehicles || []);
    } catch (e) {
      console.error('Fetch failed:', e);
      document.getElementById('update-time').textContent = 'Fel: ' + e.message;
    }
  }

  function startPolling() {
    if (pollTimer) clearInterval(pollTimer);
    fetchData();
    pollTimer = setInterval(fetchData, POLL_MS);
  }

  // ---- Stop search (async API) ----
  async function searchStops(query) {
    if (query.length < 2) { stopSearchResults = []; return; }
    try {
      const r = await fetch('api.php?action=search&q=' + encodeURIComponent(query));
      const d = await r.json();
      stopSearchResults = d.stops || [];
    } catch(e) {
      console.error('Stop search failed:', e);
      stopSearchResults = [];
    }
  }

  // ---- Fetch lines at a stop (async API) ----
  async function fetchLinesForStop(siteId) {
    try {
      const r = await fetch('api.php?action=lines&siteId=' + encodeURIComponent(siteId));
      const d = await r.json();
      return (d.lines || []).filter(l => l.transport === 'BUS').map(l => l.num);
    } catch(e) {
      console.error('Lines fetch failed:', e);
      return [];
    }
  }

  // ---- Onboarding ----
  const overlay = document.getElementById('onboarding');
  const stopSearch = document.getElementById('stop-search');
  const stopList = document.getElementById('stop-list');
  const linesGrid = document.getElementById('lines-grid');
  const saveBtn = document.getElementById('save-btn');

  function renderStopResults() {
    if (!stopSearchResults.length) {
      stopList.innerHTML = '';
      return;
    }
    stopList.innerHTML = stopSearchResults.map(s =>
      '<div class="stop-item' + (selectedStop && selectedStop.siteId === s.siteId ? ' selected' : '') +
      '" data-idx="' + stopSearchResults.indexOf(s) + '">' + s.name + '</div>'
    ).join('');
    stopList.querySelectorAll('.stop-item').forEach(el => {
      el.addEventListener('click', async function() {
        const idx = parseInt(this.dataset.idx);
        const stop = stopSearchResults[idx];
        if (!stop) return;
        selectedStop = { id: stop.id, siteId: stop.siteId, name: stop.name, lat: stop.lat, lon: stop.lon };
        stopSearch.value = stop.name;
        stopSearchResults = [];
        stopList.innerHTML = ''; // Hide results after selection

        // Fetch real lines from API
        linesGrid.innerHTML = '<div class="lines-loading">H√§mtar linjer...</div>';
        const lines = await fetchLinesForStop(stop.siteId);
        // Select ALL by default
        selectedLines = new Set(lines);
        renderLines(lines);
        checkSaveReady();
      });
    });
  }

  function renderLines(lines) {
    const label = document.getElementById('lines-label');
    if (!lines || !lines.length) {
      if (selectedStop) {
        label.textContent = 'üöç Inga busslinjer hittades';
        linesGrid.innerHTML = '<div style="color:#666;font-size:0.8rem;grid-column:1/-1">Inga avg√•ngar just nu ‚Äî prova igen senare</div>';
      } else {
        label.textContent = 'üöç V√§lj h√•llplats f√∂rst ‚Üë';
        linesGrid.innerHTML = '<div style="color:#666;font-size:0.8rem;grid-column:1/-1">S√∂k och v√§lj en h√•llplats ovan</div>';
      }
      return;
    }
    label.textContent = 'üöç Linjer vid ' + (selectedStop ? selectedStop.name : '');
    linesGrid.innerHTML = lines.map(num =>
      '<div class="line-check' + (selectedLines.has(num) ? ' checked' : '') + '" data-line="' + num + '">' +
      '<span style="color:' + lineColor(num) + ';font-weight:700">' + num + '</span></div>'
    ).join('');
    linesGrid.querySelectorAll('.line-check').forEach(el => {
      el.addEventListener('click', function() {
        const line = this.dataset.line;
        if (selectedLines.has(line)) {
          selectedLines.delete(line);
          this.classList.remove('checked');
        } else {
          selectedLines.add(line);
          this.classList.add('checked');
        }
        checkSaveReady();
      });
    });
  }

  function checkSaveReady() {
    saveBtn.disabled = !(selectedStop && selectedLines.size > 0);
  }

  function showOnboarding() {
    if (config) {
      selectedStop = config.homeStop || null;
      selectedLines = new Set(config.lines || []);
    }
    stopSearch.value = selectedStop ? selectedStop.name : '';
    stopSearchResults = [];
    if (selectedStop) {
      // Show current selection, fetch lines
      renderStopResults();
      fetchLinesForStop(selectedStop.siteId).then(lines => {
        if (!lines.length) lines = config.lines || [];
        // Keep user's current selection but show available lines
        renderLines(lines);
        checkSaveReady();
      });
    } else {
      renderStopResults();
      renderLines(null);
    }
    checkSaveReady();
    // Highlight current theme
    document.getElementById('theme-dark').style.outline = currentTheme === 'dark' ? '2px solid #60a5fa' : 'none';
    document.getElementById('theme-light').style.outline = currentTheme === 'light' ? '2px solid #3b82f6' : 'none';
    overlay.classList.add('visible');
  }

  function hideOnboarding() {
    overlay.classList.remove('visible');
  }

  // ---- Manual line add ----
  const addLineInput = document.getElementById('add-line-input');
  const addLineBtn = document.getElementById('add-line-btn');

  function addManualLine() {
    const num = addLineInput.value.trim();
    if (!num || selectedLines.has(num)) { addLineInput.value = ''; return; }
    selectedLines.add(num);
    addLineInput.value = '';
    // Re-render lines grid with the new line included
    const currentNums = Array.from(linesGrid.querySelectorAll('.line-check')).map(el => el.dataset.line);
    if (!currentNums.includes(num)) {
      // Add it to the grid
      const div = document.createElement('div');
      div.className = 'line-check checked';
      div.dataset.line = num;
      div.innerHTML = '<span style="color:' + lineColor(num) + ';font-weight:700">' + num + '</span>';
      div.addEventListener('click', function() {
        if (selectedLines.has(num)) { selectedLines.delete(num); this.classList.remove('checked'); }
        else { selectedLines.add(num); this.classList.add('checked'); }
        checkSaveReady();
      });
      linesGrid.appendChild(div);
    }
    checkSaveReady();
  }

  addLineBtn.addEventListener('click', addManualLine);
  addLineInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); addManualLine(); } });

  // Debounced search
  stopSearch.addEventListener('input', function() {
    clearTimeout(searchTimer);
    const q = this.value.trim();
    if (q.length < 2) {
      stopSearchResults = [];
      renderStopResults();
      return;
    }
    searchTimer = setTimeout(async () => {
      await searchStops(q);
      if (!stopSearchResults.length && q.length >= 2) {
        stopList.innerHTML = '<div class="stop-item" style="color:#666;cursor:default">Inga resultat</div>';
      } else {
        renderStopResults();
      }
    }, 300);
  });

  // ---- Add to Home Screen prompt ----
  const a2hsOverlay = document.getElementById('a2hs-overlay');
  const A2HS_KEY = 'bussigt_a2hs_dismissed';

  function isStandalone() {
    return window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
  }

  function detectDevice() {
    const ua = navigator.userAgent;
    if (/iPad/.test(ua) || (/Macintosh/.test(ua) && 'ontouchend' in document)) return 'ipad';
    if (/iPhone/.test(ua)) return 'iphone';
    if (/Macintosh|Mac OS X/.test(ua) && /Safari/.test(ua) && !/Chrome/.test(ua)) return 'mac';
    if (/Android/.test(ua)) return 'android';
    return null;
  }

  function showA2HS() {
    const device = detectDevice();
    const stepsEl = document.getElementById('a2hs-steps');
    let steps = '';

    if (device === 'iphone' || device === 'ipad') {
      steps = '<div class="a2hs-step"><span class="step-num">1</span><span>Tryck p√• <span class="a2hs-icon">‚éã</span> <strong>Dela</strong>-knappen i Safari (nederkant)</span></div>' +
        '<div class="a2hs-step"><span class="step-num">2</span><span>Scrolla ner och tryck <strong>"L√§gg till p√• hemsk√§rmen"</strong></span></div>' +
        '<div class="a2hs-step"><span class="step-num">3</span><span>Tryck <strong>L√§gg till</strong> ‚Äî klart! üéâ</span></div>';
    } else if (device === 'mac') {
      steps = '<div class="a2hs-step"><span class="step-num">1</span><span>I Safari-menyn, klicka <strong>Arkiv ‚Üí L√§gg till i Dock</strong></span></div>' +
        '<div class="a2hs-step"><span class="step-num">2</span><span>Klicka <strong>L√§gg till</strong> ‚Äî klart! üéâ</span></div>';
    } else if (device === 'android') {
      steps = '<div class="a2hs-step"><span class="step-num">1</span><span>Tryck p√• <strong>‚ãÆ menyn</strong> (uppe till h√∂ger)</span></div>' +
        '<div class="a2hs-step"><span class="step-num">2</span><span>V√§lj <strong>"L√§gg till p√• startsk√§rmen"</strong></span></div>' +
        '<div class="a2hs-step"><span class="step-num">3</span><span>Tryck <strong>L√§gg till</strong> ‚Äî klart! üéâ</span></div>';
    } else {
      return; // Unknown device, don't show
    }

    stepsEl.innerHTML = steps;
    a2hsOverlay.classList.add('visible');
  }

  function hideA2HS() {
    a2hsOverlay.classList.remove('visible');
    localStorage.setItem(A2HS_KEY, '1');
  }

  document.getElementById('a2hs-done').addEventListener('click', hideA2HS);
  document.getElementById('a2hs-skip').addEventListener('click', hideA2HS);

  function shouldShowA2HS() {
    if (isStandalone()) return false;
    if (localStorage.getItem(A2HS_KEY)) return false;
    return detectDevice() !== null;
  }

  saveBtn.addEventListener('click', function() {
    if (!selectedStop || selectedLines.size === 0) return;
    saveConfig();
    hideOnboarding();

    if (shouldShowA2HS()) {
      showA2HS();
    }

    applyConfig();
  });

  // ---- Apply config to map ----
  let _isInitialLoad = true;
  function applyConfig() {
    if (!config) return;
    const hs = config.homeStop;
    const lines = config.lines;

    // Title
    document.getElementById('app-sub').textContent = lines.join(', ') + ' i realtid';

    // Home marker at the actual stop coordinates
    if (hs && hs.lat && hs.lon) setHomeMarker(hs.lat, hs.lon, hs.name);

    // Center map: on initial load use saved view, otherwise center on home stop
    if (_isInitialLoad) {
      const savedView = loadMapView();
      if (savedView) map.setView([savedView.lat, savedView.lng], savedView.zoom);
      else if (hs && hs.lat && !userMarker) map.setView([hs.lat, hs.lon], DEFAULT_ZOOM);
      _isInitialLoad = false;
    } else {
      if (hs && hs.lat) map.setView([hs.lat, hs.lon], DEFAULT_ZOOM);
    }

    // Clear old bus markers
    for (const id of Object.keys(markers)) { map.removeLayer(markers[id]); delete markers[id]; }

    startPolling();
  }

  // ---- Zoom buttons ----
  document.getElementById('zoom-in').addEventListener('click', function() { map.zoomIn(); });
  document.getElementById('zoom-out').addEventListener('click', function() { map.zoomOut(); });

  // ---- Line list collapse toggle ----
  document.getElementById('line-toggle').addEventListener('click', function() {
    const list = document.getElementById('line-statuses');
    list.classList.toggle('collapsed');
    const count = list.querySelectorAll('.line-status').length;
    const totalBuses = Object.keys(markers).length;
    this.textContent = list.classList.contains('collapsed')
      ? '‚ñº Visa alla (' + count + ' linjer, ' + totalBuses + ' bussar)'
      : '‚ñ≤ Minimera';
  });

  // ---- Theme (dark/light) ----
  let currentTheme = localStorage.getItem('bussigt_theme') || 'dark';
  const darkTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
  const lightTile = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
  let tileLayer = null;

  function applyTheme(theme, save) {
    currentTheme = theme;
    if (save) localStorage.setItem('bussigt_theme', theme);
    document.body.classList.toggle('light', theme === 'light');
    // Update meta theme-color
    document.querySelector('meta[name="theme-color"]').content = theme === 'light' ? '#f5f5f5' : '#1a1a2e';
    // Swap tiles
    if (tileLayer) map.removeLayer(tileLayer);
    tileLayer = L.tileLayer(theme === 'light' ? lightTile : darkTile, {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd', maxZoom: 18,
    }).addTo(map);
    // Highlight active theme button
    document.getElementById('theme-dark').style.outline = theme === 'dark' ? '2px solid #60a5fa' : 'none';
    document.getElementById('theme-light').style.outline = theme === 'light' ? '2px solid #3b82f6' : 'none';
  }

  document.getElementById('theme-dark').addEventListener('click', function() { applyTheme('dark', true); });
  document.getElementById('theme-light').addEventListener('click', function() { applyTheme('light', true); });

  // ---- Settings button ----
  document.getElementById('settings-btn').addEventListener('click', showOnboarding);

  // ---- Geolocation ----
  let watchId = null, userMarker = null;
  document.getElementById('locate-btn').addEventListener('click', function() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId); watchId = null;
      if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
      this.classList.remove('active'); return;
    }
    this.classList.add('active');
    watchId = navigator.geolocation.watchPosition(
      p => {
        const ll = [p.coords.latitude, p.coords.longitude];
        if (!userMarker) {
          userMarker = L.circleMarker(ll, {radius:7,fillColor:'#60a5fa',fillOpacity:1,color:'#fff',weight:2}).addTo(map).bindPopup('Du √§r h√§r');
          map.setView(ll, 15);
        } else userMarker.setLatLng(ll);
      },
      () => { document.getElementById('locate-btn').classList.remove('active'); watchId = null; },
      {enableHighAccuracy: true}
    );
  });

  // ---- Apply initial theme ----
  applyTheme(currentTheme, false);

  // ---- Init ----
  clearTimeout(_initTimeout);

  if (loadConfig()) {
    hideOnboarding();
    applyConfig();
  } else {
    selectedLines = new Set();
    showOnboarding();
  }

})();
</script>
</body>
</html>
